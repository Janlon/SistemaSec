@model SiteSec.Models.ItemOrdemServico

@using (Html.BeginForm())
{

    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        @Html.HiddenFor(model=>model.ListaResultados)
        <div id="treeview"></div>
    </div>
}

<script>

    $(document).ready(function () {

        function checkedNodeIds(nodes, checkedNodes) {
            for (var i = 0; i < nodes.length; i++) {

                if (nodes[i].checked) 
                    checkedNodes.push(nodes[i].id);
                
                if (nodes[i].hasChildren) 
                    checkedNodeIds(nodes[i].children.view(), checkedNodes);          
            }
        }

        function onCheck() {
            var checkedNodes = [],
                treeView = $("#treeview").data("kendoTreeView"),
                message;

            checkedNodeIds(treeView.dataSource.view(), checkedNodes);

            if (checkedNodes.length > 0) {
                message = checkedNodes.join(",");
            }

            $("#ListaResultados").val(message).trigger("change");
        }

        $.ajax({
            cache: false,
            type: 'GET',
            url: '@Url.Action("EquipamentosDosSetoresDaEmpresa", "ItemOrdemServico")',
            data: { ordemId : @ViewBag.OrdemServicoId },
            contentType: "json",
            success: function (data)
            {
                var setores = new Array();
                for (var i in data) {
                    var equipamentos = new Array();
                    for (var x in data[i].Equipamentos) {
                        var servicos = new Array();
                        for (var z in data[i].Equipamentos[x].Servicos) {

                            var idSetor = data[i].Id;
                            var idEquipamento = data[i].Equipamentos[x].Id;
                            var idServico = data[i].Equipamentos[x].Servicos[z].Id;

                            servicos.push({ 'id': 'setorId=' + idSetor + ';equipamentoId=' + idEquipamento + ';servicoId=' + idServico, 'text': data[i].Equipamentos[x].Servicos[z].Descricao });
                        }
                        equipamentos.push({ 'id': data[i].Equipamentos[x].Id, 'text': data[i].Equipamentos[x].Descricao, 'items': servicos });
                    }
                    setores.push({ 'id': data[i].Id, 'text': data[i].Descricao, 'items': equipamentos });
                }
                var ds = new kendo.data.HierarchicalDataSource({ data : setores });
                $("#treeview").kendoTreeView({
                    dataSource: ds,
                    check: onCheck,
                    checkboxes: { checkChildren: true },
                });    
            }
        });
    });

</script>
